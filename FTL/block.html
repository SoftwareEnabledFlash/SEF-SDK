<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-FTL/block" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Block Layer | SDK Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="robots" content="noindex, nofollow"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://SoftwareEnabledFlash.github.io/SEF-SDK/FTL/block"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Block Layer | SDK Docs"><meta data-rh="true" name="description" content="chap-Block}"><meta data-rh="true" property="og:description" content="chap-Block}"><link data-rh="true" rel="icon" href="/SEF-SDK/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://SoftwareEnabledFlash.github.io/SEF-SDK/FTL/block"><link data-rh="true" rel="alternate" href="https://SoftwareEnabledFlash.github.io/SEF-SDK/FTL/block" hreflang="en"><link data-rh="true" rel="alternate" href="https://SoftwareEnabledFlash.github.io/SEF-SDK/FTL/block" hreflang="x-default"><link rel="stylesheet" href="/SEF-SDK/assets/css/styles.caa6f932.css">
<link rel="preload" href="/SEF-SDK/assets/js/runtime~main.9383a551.js" as="script">
<link rel="preload" href="/SEF-SDK/assets/js/main.82698aa3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/SEF-SDK/"><div class="navbar__logo"><img src="/SEF-SDK/img/sef-light-logo.png" alt="SEF Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/SEF-SDK/img/sef-light-dark.png" alt="SEF Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">SDK Docs</b></a><a href="https://softwareenabledflash.github.io/SEF-API/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">API Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/SEF-SDK/">1.00</a><a href="https://github.com/SoftwareEnabledFlash/SEF-SDK/blob/v1.00/SEF-SDK-01-00.pdf" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Download PDF<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/SoftwareEnabledFlash/SEF-SDK" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/SEF-SDK/">Legal Disclaimer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/SEF-SDK/intended-audience">Intended Audience</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/SEF-SDK/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/SEF-SDK/definitions">Definitions and Acronyms</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/SEF-SDK/security-model">Security Model</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/SEF-SDK/build-instructions">Build Instructions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/SEF-SDK/Driver/overview">Driver</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/SEF-SDK/Library/overview">SEF Library</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/SEF-SDK/FTL/overview">Reference FTL</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/SEF-SDK/FTL/overview">SEF Reference Flash Translation Layer (FTL)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/SEF-SDK/FTL/block">Block Layer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/SEF-SDK/FTL/flash-translation-layer">Flash Translation Layer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/SEF-SDK/FTL/superblock-management">Super Block State Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/SEF-SDK/FTL/garbage-collection">Garbage Collection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/SEF-SDK/FTL/persistence">Persistence</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/SEF-SDK/FTL/instrumentation">Instrumentation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/SEF-SDK/FTL/logging">Logging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/SEF-SDK/FTL/ftl-api">SEF FTL Public API</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/SEF-SDK/CLI/overview">Command Line Interface (CLI)</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/SEF-SDK/FIO/overview">Flexible I/O Tester (FIO)</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/SEF-SDK/QEMU/overview">QEMU</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/SEF-SDK/NVMe-CLI/overview">NVMe-CLI</a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/SEF-SDK/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Reference FTL</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Block Layer</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Block Layer</h1><p>The block layer is the public API for the Reference FTL and implements an asynchronous block API.
It uses the flash translation layer (FTL) to map user LBAs to device flash addresses. The properties
of a configured QoS Domain are read using <a href="/SEF-SDK/FTL/ftl-api#function-SEFBlockGetInfo">SEFBlockGetInfo</a>. The
<code>deferMount</code> member in struct <a href="/SEF-SDK/FTL/ftl-api#struct-SEFBlockOption">SEFBlockOption</a> can be set to <code>true</code>
to create a context to quickly access properties without having to perform a full initialization.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="io">I/O<a href="#io" class="hash-link" aria-label="Direct link to I/O" title="Direct link to I/O">​</a></h2><p>Block I/O is issued by calling <a href="/SEF-SDK/FTL/ftl-api#function-SEFBlockIO">SEFBlockIO</a>. It places no restriction on
the size of a write, but the SEF Library will break large writes up into multiple smaller writes based
on device and operating system limits. There is also no restriction on the size of a read, but large
reads will be broken up into smaller reads of contiguous runs of flash addresses. Typically, if data
was written with one write, it can be read with one read until it crosses a Super Block boundary.
However, after portions are rewritten by the client or have been moved on flash as part of a garbage
collection (GC), runs can be shortened. More SEF read requests will be required to read the same
data. This is handled automatically by the block layer for the caller.</p><p>As an example, this is a section of the LUT and a newly erased Super Block after two writes. The
first was a write to LBA 0 of 3 ADUs in blue and the second was a write to LBA 4 of 3 ADUs in
yellow.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fig-WriteExample1">Figure 2: Write Example 1<a href="#fig-WriteExample1" class="hash-link" aria-label="Direct link to Figure 2: Write Example 1" title="Direct link to Figure 2: Write Example 1">​</a></h4><p><img loading="lazy" alt="Write Example 1" src="/SEF-SDK/assets/images/ftl-write-example-1-8af1a54a82bfa26f82a961adc8ab3531.png" width="400" height="441" class="img_ev3q"></p><p>When a client issues a read of LBA 0 through 6, internally the block layer will need to issue 3 calls
to <code>sbmWholeRead()</code>. The flash addresses are contiguous, but the LBA addresses are not. The
first call will issue a read for LBA0/ADU0 of 3 ADUs, the second call will not issue a read, but
will fill the buffer for LBA 3 with zeros and the third call will issue a read for LBA4/ADU3 of 3
ADUs.</p><p>After the gap at LBA 3 is filled by a third write in green to LBA 2 of 3 ADUs, this is how the LUT
and Super Block appear:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fig-WriteExample2">Figure 3: Write Example 2<a href="#fig-WriteExample2" class="hash-link" aria-label="Direct link to Figure 3: Write Example 2" title="Direct link to Figure 3: Write Example 2">​</a></h4><p><img loading="lazy" alt="Write Example 2" src="/SEF-SDK/assets/images/ftl-write-example-2-1c16a6778808e44d0b80123438fe4e6e.png" width="400" height="441" class="img_ev3q"></p><p>The gap at LBA 3 has been filled. ADUs 2 and 3 are colored red because they are unreachable
through the LUT and have been marked as invalid in the Super Block layer. GC skips ADUs
marked as invalid. Another result of the write is the flash addresses are no longer contiguous. A
client reading LBAs 0 through 6 will result in 3 calls to <code>sbmWholeRead()</code>. The first call will issue
a read for LBA0/ADU0 of 2 ADUs, the second call will issue a read for LBA2/ADU6 of 3 ADUs
and the third call will issue a read for LBA5/ADU4 of 2 ADUs.</p><p>Reads can be issued as soon as the LUT is updated, but because an SEF Unit can delay the write
of data to flash, when a bad block is encountered, a previously returned tentative flash address
will be asynchronously updated via the QoS Domain’s notification function. When the read of a
tentative flash address has been issued against an updated flash address, it will fail and needs to
be retried with the updated flash address. The block layer handles re-issuing the read using the
updated flash address. See <a href="/SEF-SDK/FTL/block#sec-delayedWrites">Delayed Writes</a> for details.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="io-priority">I/O priority<a href="#io-priority" class="hash-link" aria-label="Direct link to I/O priority" title="Direct link to I/O priority">​</a></h2><p>The I/O priority used for reads and writes is inherited from the default weights configured for the
QoS Domain and read FIFOs from the Virtual Device. However, when a garbage collect is active,
the write and copy weights are adjusted by the block layer such that the throughput of read stays
unchanged. The priority of GC copies vs. writes is adjusted by <code>sbmAdjustIOWeights</code> at the start
of every GC-issued copy command.</p><p>Even though priority can be adjusted for every copy command, the current priority scheme is fixed and
based on the worst-case WAF, which can be calculated from the amount of over-provisioning.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">WAF &lt;= 1/OP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Every user write requires GC to write <code>WAF − 1</code> more.
That is, the ratio of copy to write weights has to be at least <code>WAF − 1</code>
to not be overrun by user writes. At the same time, the sum of the weights must be equal to the
default program weight to not affect read die time.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">programWeight = defaultWeight ∗ WAF </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">copyWeight = defaultWeight ∗ (WAF −1) / WAF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>At the end of a GC cycle, the program weight is restored to the default weight.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sec-delayedWrites">Delayed Writes<a href="#sec-delayedWrites" class="hash-link" aria-label="Direct link to Delayed Writes" title="Direct link to Delayed Writes">​</a></h2><p>An SEF Unit uses delayed writes to quickly respond with a flash address but remove the burden of
the client handling the program size of the device. This requires the buffer lifetime to be longer
than completion of <a href="/SEF-SDK/FTL/ftl-api#function-SEFBlockIO">SEFBlockIO</a>. This introduces extra overhead in the
form of a buffer allocation and data copy. The impact of delayed writes can be eliminated by the
client taking responsibility for buffer management.</p><p>When the flag kSEFBlockIOFlagNotifyBufferRelease is set in a struct
<a href="/SEF-SDK/FTL/ftl-api#struct-SEFMultiContext">SEFMultiContext</a> I/O request, the caller’s buffer is used for
delayed writes. That is, the buffer passed in must continue to be valid, even after the I/O’s completion
routine has been called. Once the second phase of write is complete, the FTL client will receive
a struct <a href="/SEF-SDK/FTL/ftl-api#struct-SEFBlockNotify">SEFBlockNotify</a> through the notify routine supplied in struct
<a href="/SEF-SDK/FTL/ftl-api#struct-SEFBlockOption">SEFBlockOption</a> when <a href="/SEF-SDK/FTL/ftl-api#function-SEFBlockInit">SEFBlockInit</a> was
called. The iov and iovcnt members describe the portion of the write buffer that is now committed
to flash. A delayed write typically completes in milliseconds but can take tens of minutes to
complete when there is insufficient data to fill the device’s internal write buffer. The SDK includes
a sample buddy allocator that can allocate a large buffer with minimal fragments where portions of
the buffer are freed at different times.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="crash-recovery">Crash Recovery<a href="#crash-recovery" class="hash-link" aria-label="Direct link to Crash Recovery" title="Direct link to Crash Recovery">​</a></h3><p>The LUT is kept entirely in DRAM by the FTL layer. If the FTL client process were to
crash, the LUT and data saved on the device would be out of sync. When this happens,
<a href="/SEF-SDK/FTL/ftl-api#function-SEFBlockInit">SEFBlockInit</a> will fail. This can be fixed by repairing the LUT
using <a href="/SEF-SDK/FTL/ftl-api#function-SEFBlockCheck">SEFBlockCheck</a>. Enough metadata is kept with each write to
reconstruct the LUT, even when it is entirely lost.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/SEF-SDK/FTL/overview"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">SEF Reference Flash Translation Layer (FTL)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/SEF-SDK/FTL/flash-translation-layer"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Flash Translation Layer</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#io" class="table-of-contents__link toc-highlight">I/O</a></li><li><a href="#io-priority" class="table-of-contents__link toc-highlight">I/O priority</a></li><li><a href="#sec-delayedWrites" class="table-of-contents__link toc-highlight">Delayed Writes</a><ul><li><a href="#crash-recovery" class="table-of-contents__link toc-highlight">Crash Recovery</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Software-Enabled Flash Project. Built with Docusaurus.</div></div></div></footer></div>
<script src="/SEF-SDK/assets/js/runtime~main.9383a551.js"></script>
<script src="/SEF-SDK/assets/js/main.82698aa3.js"></script>
</body>
</html>