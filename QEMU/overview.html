<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-QEMU/overview" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">QEMU | SDK Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="robots" content="noindex, nofollow"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://SoftwareEnabledFlash.github.io/SEF-SDK/QEMU/overview"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="QEMU | SDK Docs"><meta data-rh="true" name="description" content="chap-qemu}"><meta data-rh="true" property="og:description" content="chap-qemu}"><link data-rh="true" rel="icon" href="/SEF-SDK/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://SoftwareEnabledFlash.github.io/SEF-SDK/QEMU/overview"><link data-rh="true" rel="alternate" href="https://SoftwareEnabledFlash.github.io/SEF-SDK/QEMU/overview" hreflang="en"><link data-rh="true" rel="alternate" href="https://SoftwareEnabledFlash.github.io/SEF-SDK/QEMU/overview" hreflang="x-default"><link rel="stylesheet" href="/SEF-SDK/assets/css/styles.caa6f932.css">
<link rel="preload" href="/SEF-SDK/assets/js/runtime~main.9383a551.js" as="script">
<link rel="preload" href="/SEF-SDK/assets/js/main.82698aa3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/SEF-SDK/"><div class="navbar__logo"><img src="/SEF-SDK/img/sef-light-logo.png" alt="SEF Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/SEF-SDK/img/sef-light-dark.png" alt="SEF Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">SDK Docs</b></a><a href="https://softwareenabledflash.github.io/SEF-API/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">API Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/SEF-SDK/">1.00</a><a href="https://github.com/SoftwareEnabledFlash/SEF-SDK/blob/v1.00/SEF-SDK-01-00.pdf" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Download PDF<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/SoftwareEnabledFlash/SEF-SDK" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/SEF-SDK/">Legal Disclaimer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/SEF-SDK/intended-audience">Intended Audience</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/SEF-SDK/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/SEF-SDK/definitions">Definitions and Acronyms</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/SEF-SDK/security-model">Security Model</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/SEF-SDK/build-instructions">Build Instructions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/SEF-SDK/Driver/overview">Driver</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/SEF-SDK/Library/overview">SEF Library</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/SEF-SDK/FTL/overview">Reference FTL</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/SEF-SDK/CLI/overview">Command Line Interface (CLI)</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/SEF-SDK/FIO/overview">Flexible I/O Tester (FIO)</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/SEF-SDK/QEMU/overview">QEMU</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/SEF-SDK/QEMU/overview">QEMU</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/SEF-SDK/NVMe-CLI/overview">NVMe-CLI</a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/SEF-SDK/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">QEMU</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">QEMU</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>QEMU</h1><p>The Software-Enabled Flash™️ (SEF) Software Development Kit (SDK) includes QEMU storage
devices that allow non-SEF enabled software to be tested with an SEF Unit. The storage devices
translate block APIs into SEF commands storing the data in an SEF Unit. The storage devices
included are:</p><ul><li>An <a href="#subsec-qemuExVD">SEF-Backed Virtual Driver</a></li><li>An <a href="#subsec-qemuNVMe">SEF-Backed NVMe Driver with FDP support</a></li><li>An <a href="#subsec-qemuExZNS">SEF-Backed ZNS Device</a></li></ul><p>To use them, an SEF Unit and SEF QoS Domain are supplied as parameters. The storage devices
then present a block device to the QEMU guest based on the SEF QoS Domain’s configuration. See
each sub-section for details on how to use them.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="subsec-qemuExVD">SEF-Backed Virtual Driver<a href="#subsec-qemuExVD" class="hash-link" aria-label="Direct link to SEF-Backed Virtual Driver" title="Direct link to SEF-Backed Virtual Driver">​</a></h2><p>The SEF patches for QEMU add support for a virtual driver called sef-aio. Instead of using a file for
a backing store, it uses an SEF QoS Domain. The QoS Domain must be unconfigured or configured
as an SEF Block FTL domain. An unconfigured domain will be auto configured as an SEF Block
FTL domain when it’s mounted. The file option selects the unit and QoS Domain and has the
following format: <code>file=&lt;unit&gt;:&lt;domain&gt;</code>. Below is an example of a QEMU command line with
options for an SEF Virtual Device on SEF Unit 0 and QoS Domain 3.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$sudo qemu -name sefAio -m 4G -smp 8 -enable-kvm                                              \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -drive file=system-debian.qcow2,cache=none,format=qcow2,if=virtio                           \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -netdev user,id=vnet,hostfwd=tcp:127.0.0.1:2222-:22                                         \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -device virtio-net-pci,netdev=vnet -nographic                                               \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -display none -cpu host                                                                     \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -drive driver=sef-aio,file=0:3,cache=none,if=virtio</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To verify the virtual drive is present, run the command lsblk. In this case, it’s the device
vdb.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$sudo lsblk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME     MAJ:MIN RM      SIZE RO TYPE MOUNTPOINT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fd0         2:0      1      4K   0 disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sr0       11:0       1 1024M     0 rom</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vda      254:0       0   100G    0 disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-vda1 254:1         0    96G    0 part /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-vda2 254:2         0      1K   0 part</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-vda5 254:5         0      4G   0 part [SWAP]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vdb      254:16      0   4.3G    0 disk</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FIO can be used for testing the device from within the virtual machine. Below is an example that
randomly reads and writes to the device.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$sudo fio -ioengine=libaio -filename=/dev/vdb -name=rw -randrw</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="subsec-qemuExZNS">SEF-Backed ZNS Device<a href="#subsec-qemuExZNS" class="hash-link" aria-label="Direct link to SEF-Backed ZNS Device" title="Direct link to SEF-Backed ZNS Device">​</a></h2><p>The standard NVMe device for QEMU supports ZNS. Using it requires that the guest
OS has a Linux kernel of 5.9 or later. It’s enabled with the option <code>zoned=true</code>. The
SEF patches for QEMU add support for using an SEF QoS Domain as a backing store.
<a href="#tab-qemuZnsOptions">SEF-specific ZNS Device Options</a> shows the SEF-specific options. The
SEF QoS Domain used must be unconfigured or configured as an SEF ZNS domain. An unconfigured
domain will be auto configured as an SEF ZNS domain.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tab-qemuZnsOptions">SEF-specific ZNS Device Options<a href="#tab-qemuZnsOptions" class="hash-link" aria-label="Direct link to SEF-specific ZNS Device Options" title="Direct link to SEF-specific ZNS Device Options">​</a></h4><table><thead><tr><th>Option</th><th>Default Value</th><th>Description</th></tr></thead><tbody><tr><td>sef</td><td>false</td><td>If true, switches from a file as a backing store to an SEF QoS Domain. In this mode, a zone is an SEF Super Block, which dictates the default zone. Setting the zone size smaller is supported but will waste space.</td></tr><tr><td>sef_unit</td><td>0</td><td>Unit number of the SEF Unit to use as the backing store.</td></tr><tr><td>sef_qos_domain</td><td>2</td><td>QoS Domain ID to use as the backing store.</td></tr></tbody></table><p>Below is an example of a QEMU command line with options for an SEF-backed ZNS device on QoS
Domain 3. Although unused, it’s still required to supply a valid backing file, even if it&#x27;s zero-sized.
The example is using the default of 0 for the SEF Unit number and explicitly configuring QoS
Domain 3.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$sudo qemu -name sefZns -m 4G -smp 8 -enable-kvm                                                \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -drive file=system-debian.qcow2,cache=none,format=qcow2,if=virtio                             \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -netdev user,id=vnet,hostfwd=tcp:127.0.0.1:2222-:22                                           \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -device virtio-net-pci,netdev=vnet -nographic                                                 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -display none -cpu host                                                                       \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -drive if=none,id=nvme1,file=nvme3.raw,format=raw                                             \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -device nvme,serial=654321                                                                    \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -device nvme-ns,drive=nvme1,nsid=1,sef=true,zoned=true,                                       \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sef_qos_domain=3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To verify the ZNS device is present, run the command <code>lsblk -z</code>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$sudo lsblk -z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME        ZONED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fd0         none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sr0         none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vda         none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-vda1      none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-vda2      none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-vda5      none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nvme0n1 host-managed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The indication “host managed” tells you that device nvme0n1 is a ZNS device.</p><p>FIO can be used for testing ZNS devices from within the virtual machine. Below is an example
that randomly reads and writes 8 gigabytes of data using 128k I/O requests. The request types are
evenly split between reads and writes, yielding 4 gigabytes of reads and 4 gigabytes of writes.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$sudo fio --aux-path=/tmp --allow_file_create=0 --name=job1         \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --filename=/dev/nvme0n1 --rw=randrw --direct=1                    \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --zonemode=zbd --bs=128k --size=8G</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When run only once, it will not fill the device since half of the size is used for reads, and size
will be rounded down to the device size if larger. To see how much data has been written, run
<code>blkzone report /dev/nvme0n1</code> for the write pointer value of each zone. By running the fio
job more than once, it will eventually fill a zone, which will then be reset/erased to allow for more
writes.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$sudo blkzone report /dev/nvme0n1 | head -2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000000000, len 0x010000, cap 0x010000, wptr 0x009800</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          reset:0 non-seq:0, zcond: 2(oi) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000010000, len 0x010000, cap 0x010000, wptr 0x00aa00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          reset:0 non-seq:0, zcond: 2(oi) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="subsec-qemuNVMe">SEF-Backed NVMe Device<a href="#subsec-qemuNVMe" class="hash-link" aria-label="Direct link to SEF-Backed NVMe Device" title="Direct link to SEF-Backed NVMe Device">​</a></h2><p>The SEF patches for QEMU add support for using an SEF QoS Domain as a backing store for a
QEMU NVMe device. <a href="#tab-qemuNvmeOptions">SEF-specific NVMe Device Options</a> shows the
SEF-specific options. The QoS Domain must be unconfigured or configured as an SEF Block FTL
domain. An unconfigured domain will be auto configured as an SEF Block FTL domain when it’s
mounted.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tab-qemuNvmeOptions">SEF-specific NVMe Device Options<a href="#tab-qemuNvmeOptions" class="hash-link" aria-label="Direct link to SEF-specific NVMe Device Options" title="Direct link to SEF-specific NVMe Device Options">​</a></h4><table><thead><tr><th>Option</th><th>Default Value</th><th>Description</th></tr></thead><tbody><tr><td>sef</td><td>false</td><td>If true, switches from a file as a backing store to an SEF QoS Domain. In this mode, the SEF reference FTL is used to provide block I/O for the QEMU NVMe device.</td></tr><tr><td>sef_unit</td><td>0</td><td>Unit number of the SEF Unit to use as the backing store.</td></tr><tr><td>sef_qos_domain</td><td>2</td><td>QoS Domain ID to use as the backing store.</td></tr></tbody></table><p>Below is an example of a QEMU command line with options for an SEF-backed NVMe device
on QoS Domain 2. Although unused, it’s still required to supply a valid backing file, even if it’s
zero-sized. The example is using the default of 0 for the SEF Unit number and the default of 2 for
the QoS Domain.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$sudo qemu -name sefNvme -m 4G -smp 8 -enable-kvm                                     \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -drive file=system-debian.qcow2,cache=none,format=qcow2,if=virtio                   \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -netdev user,id=vnet,hostfwd=tcp:127.0.0.1:2222-:22                                 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -device virtio-net-pci,netdev=vnet -nographic                                       \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -display none -cpu host                                                             \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -drive if=none,id=nvme1,file=nvme2.raw,format=raw                                   \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -device nvme,serial=123456                                                          \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -device nvme-ns,drive=nvme1,nsid=1,sef=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To verify the virtual drive is present, run the command <code>lsblk</code>. In this case, it’s the device
vdb.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$sudo lsblk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME     MAJ:MIN RM          SIZE RO TYPE MOUNTPOINT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fd0         2:0      1         4K    0 disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sr0       11:0       1 1024M         0 rom</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vda      254:0       0       100G    0 disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-vda1 254:1         0        96G    0 part /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-vda2 254:2         0         1K    0 part</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-vda5 254:5         0         4G    0 part [SWAP]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nvme0n1 259:0            0    4.3G    0 disk</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FIO can be used for testing the device from within the virtual machine. Below is an example that
randomly reads and writes to the device.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$sudo fio -ioengine=libaio -filename=/dev/nvme0n1 -name=rw -randrw</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/SEF-SDK/FIO/overview"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Flexible I/O Tester (FIO)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/SEF-SDK/NVMe-CLI/overview"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">NVMe-CLI</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#subsec-qemuExVD" class="table-of-contents__link toc-highlight">SEF-Backed Virtual Driver</a></li><li><a href="#subsec-qemuExZNS" class="table-of-contents__link toc-highlight">SEF-Backed ZNS Device</a></li><li><a href="#subsec-qemuNVMe" class="table-of-contents__link toc-highlight">SEF-Backed NVMe Device</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Software-Enabled Flash Project. Built with Docusaurus.</div></div></div></footer></div>
<script src="/SEF-SDK/assets/js/runtime~main.9383a551.js"></script>
<script src="/SEF-SDK/assets/js/main.82698aa3.js"></script>
</body>
</html>